var PORT = 3000;
var MONGODBURL = 'mongodb://127.0.0.1:27017';
var DATABASENAME = "admin";

var express = require('express');
var bodyParser = require('body-parser');

// DB connexion
var db;
const MongoClient = require('mongodb').MongoClient;
var ObjectID = require('mongodb').ObjectID;
MongoClient.connect(MONGODBURL, (err, client) => {
  if (err) return console.log(err);
  db = client.db(DATABASENAME);
  app.listen(PORT, () => {
    console.log('listening on ' + PORT);
  }).on('error', function(err){
    console.log('on error handler');
    console.log(err);
  })
});

var app = express();
//app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());

// path where files are not processed
app.use(express.static('client'));

// default root
app.get('/', function (req, res) {
  res.send('Hello World!');
});

app.post('/gramma', function (req,res){
	let resObj = {mots:[]}; 
	let motsTab = req.body.data.split(" ");
    resObj.motsTab = motsTab;
    let end = 0;
    for(var i =0; i<motsTab.length; i++){
        let element = {
            results: [],
            index: i
        };
        db.collection('mots').find(
            /*{ 
                $and : 
                    [
                        { 
                            "valeur": 
                                { 
                                    $in: motsTab 
                                } 
                        },
                        {
                            "catgram": 
                                { 
                                    $in : 
                                        [ 
                                            "nom",
                                            "article",
                                            "article indéfini",
                                            "article défini",
                                            "adjectif démonstratif",
                                            "adjectif numéral cardinal",
                                            "adjectif numéral ordinal",
                                            "adjectif indéfini",
                                            "adjectif numéral",
                                            "adjectif relatif",
                                            "adjectif possessif",
                                            "adjectif exclamatif",
                                            "adjectif interrogatif"
                                        ]
                                }
                        }
                    ]
            }*/

            { 
                "valeur": motsTab[i]
            }
        )/*.project(
            {
                "_id":0, 
                "valeur":1, 
                "catgram":1,
                "references.variante":1,
                "references.orthographe":1,
                "references.forme":1
            }
        )*/.toArray((err, result) => {
            if (err) return console.log(err)
            element.results = result;
            resObj.mots.push(element);
            end++;
            if(end == motsTab.length) {
                resObj.mots.sort(function(a,b) {return a.index-b.index});
                res.send(resObj);
            } 
        })
    }

})

app.post('/gramma/:catgram', function (req,res){
    let resObj = {mots:[]}; 
    let motsTab = req.body.phrase.split(" ");
    let i = 0;
    let search = function(){
        db.collection('mots').find({"mot": motsTab[i]}, {mot:1, _id:0}).toArray((err, result) => {
            if (err) return console.log(err)
            resObj.mots.push(result);
            if (i === motsTab.length-1 ){
                res.send(resObj);
            } else {
                i++;
                search();
            }
        })
    };
    search();
})

// GET : read all
app.get('/mots/', function (req,res){
    console.log("liste des mots");
    db.collection('mots').find().toArray((err, result) => {
        if (err) return console.log(err)
        console.log(result);
        res.send(result);
    })
})


            /******************************************************************
             *                                                                *
             *                  RECUPERATION DES DEFINITIONS                  *
             *                                                                *
             ******************************************************************/     

var http = require('http');
var fs = require('fs');

var dataAll;
var index = 1;
var alphabet = "abcdefghijklmnopqrstuvwxyz";
var letter = 0;

var listeUrlMots = require('./listeUrlMots');
var indexDef = 0;
var dataAllDef = "";
var dataPart = "";

var listeUrlImgs = require('./listeUrlImgs');
var indexDefImg = 0;
var dataAllImg = "";
var dataPartImg = "";

var getUrlsMots = function(){
    http.get('http://www.larousse.fr/index/dictionnaires/francais/' + alphabet[letter] + '/' + index, function(res){

        res.on('data', function(data){
            dataAll += data;
            if (res.statusCode === 200) {
                dataAll += data; 
            }
        });

        res.on('end', function () {
            index++;
            if(index <= 70){
                getUrlsMots();
            } else {
                console.log(alphabet[letter]);
                letter++;
                if(letter < 26) {
                    index = 1;
                    getUrlsMots();
                } else {
                    fs.writeFile('All.txt', dataAll , function (err) {
                        if (err) throw err;
                        console.log('It\'s saved!');
                    });
                }
            }
        });

        res.on('error', function(e){
            //console.log(e);
        });

    });
}

var getDefs = function(){
    http.get(listeUrlMots.urls[indexDef], function(res){

        res.on('data', function(data){
            //dataAll += data;
            if (res.statusCode === 200) {
                dataPart += data;
            }
        });

        res.on('end', function () {
            dataAllDef += dataPart.substring(
                dataPart.lastIndexOf('<article class="BlocDefinition content" role="article">'),
                dataPart.indexOf("</article>", 
                    dataPart.lastIndexOf('<article class="BlocDefinition content" role="article">')
                )
            ) + "</article>";
            dataPart = "";
            console.log(listeUrlMots.urls[indexDef]);
            indexDef++;
            if(indexDef < listeUrlMots.urls.length){
                fs.writeFile('AllDefs.txt', dataAllDef , function (err) {
                    if (err) {
                        console.log(err);
                        indexDef--;
                        getDefs();
                    }
                    console.log('It\'s saved!');
                    //setTimeout(()=>{
                        getDefs();
                    //},4000);
                });
            } else {
                fs.writeFile('AllDefs.txt', dataAllDef , function (err) {
                    if (err) throw err;
                    console.log('It\'s saved!');
                });
            }
        });
 
        res.on('error', function(e){
            console.log(e);
            getDefs();
        });

    });
}

var getImgs = function(){
    http.get(listeUrlImgs.urls[indexDefImg], function(res){

        res.on('data', function(data){
            //dataAll += data;
            if (res.statusCode === 200) {
                dataPartImg += data;
            }
        });

        res.on('end', function () {
            dataAllImg += dataPartImg;
            dataPartImg = "";
            console.log(listeUrlImgs.urls[indexDefImg]);
            indexDefImg++;
            if(indexDefImg < listeUrlImgs.urls.length){
                fs.writeFile('AllImg' + indexDefImg, dataAllImg , function (err) {
                    if (err) {
                        console.log(err);
                        indexDefImg--;
                        getImgs();
                    }
                    dataAllImg = "";
                    console.log('It\'s saved!');
                    //setTimeout(()=>{
                        getImgs();
                    //},4000);
                });
            } else {
                fs.writeFile('Allimg' + indexDefImg, dataAllImg , function (err) {
                    if (err) throw err;
                    dataAllImg = "";
                    console.log('It\'s saved!');
                });
            }
        });
 
        res.on('error', function(e){
            console.log(e);
            getImgs();
        });
 
    });
}

//var listeUrlMots = require('./listeUrlMots');
/*var listIndexUrlMots = [
    "51","71","87","95","102","118","228","268","285","331","367","390","391","516","581","707","751","782","897","982","1003","1145","1187","1316","1331","1343","1354","1445","1613","1693","1716","1785","1869",
    "1904","1905","1939","2003","2004","2095","2100","2102","2125","2137","2155","2180","2212","2242","2313","2364","2383","2446","2459","2461","2494","2509","2531","2565","2566","2589","2612","2641","2668","2852",
    "2933","2941","2945","3003","3011","3013","3040","3051","3086","3254","3276","3392","3429","3451","3498","3503","3543","3580","3638","3647","3719","3736","3813","3893","3976","3993","4023","4127","4135","4285",
    "4406","4614","4626","4858","4876","4891","4892","4893","4911","4920","4926","4946","4974","4990","4997","5013","5021","5060","5078","5153","5281","5285","5286","5289","5308","5320","5547","5554","5575","5627",
    "5628","5648","5707","5772","5790","5792","5947","5953","5973","6002","6010","6055","6101","6126","6130","6132","6146","6206","6219","6295","6417","6541","6746","6749","6751","6758","6760","6762","6841","6844",
    "6892","7078","7083","7097","7111","7140","7197","7240","7312","7313","7392","7440","7540","7592","7639","7680","7704","7760","7775","7778","7808","7845","7863","7918","8033","8060","8073","8093","8104","8177",
    "8187","8200","8202","8226","8268","8280","8291","8296","8362","8374","8393","8410","8513","8545","8703","8772","8850","8960","8970","8984","9027","9044","9064","9114","9120","9139","9187","9261","9280","9368",
    "9411","9430","9448","9468","9475","9600","9676","9723","9797","9838","9858","9942","9955","9968","9993","10019","10034","10100","10324","10360","10379","10419","10422","10475","10528","10572","10624","10649",
    "10699","10767","10797","10802","10813","10852","10880","10913","10943","10952","11005","11213","11284","11287","11292","11445","11451","11455","11494","11506","11621","11649","11750","11752","11795","11849",
    "11884","11933","11936","11943","12004","12081","12087","12148","12176","12231","12236","12310","12332","12336","12346","12368","12392","12419","12420","12449","12510","12521","12533","12540","12544","12599",
    "12604","12611","12724","12747","12750","12753","12848","12890","12902","12906","12930","12971","13016","13103","13143","13176","13204","13287","13298","13334","13348","13396","13444","13454","13468","13483",
    "13488","13507","13668","13739","13785","13830","13895","13985","14026","14071","14125","14126","14186","14203","14204","14236","14245","14262","14274","14317","14338","14357","14410","14438","14453","14496",
    "14502","14539","14560","14572","14659","14688","14715","14738","14743","14779","14831","14832","14844","14898","14902","14950","14956","15005","15021","15024","15075","15095","15107","15118","15180","15182",
    "15202","15217","15286","15346","15391","15489","15501","15533","15627","15633","15674","15721","15726","15734","15768","15824","15835","15871","15995","15997","16003","16008","16013","16019","16037","16119",
    "16145","16154","16178","16216","16391","16411","16417","16463","16478","16534","16542","16551","16635","16714","16791","16852","16868","16897","16923","16966","17083","17093","17097","17111","17174","17211",
    "17224","17256","17289","17295","17300","17357","17401","17412","17413","17415","17425","17459","17528","17588","17620","17741","17779","17783","17822","17857","17866","17878","17922","17968","17984","18053",
    "18092","18136","18227","18245","18248","18252","18427","18466","18484","18504","18551","18603","18720","18780","18848","19006","19073","19167","19174","19214","19223","19236","19248","19250","19310","19319",
    "19331","19337","19339","19372","19474","19637","19666","19683","19705","19751","19757","19760","19805","19855","19864","19881","19922","19942","19985","20029","20037","20108","20114","20202","20252","20269",
    "20339","20518","20525","20526","20534","20593","20606","20613","20618","20626","20631","20632","20639","20692","20764","20864","20886","20912","20939","20954","20993","20994","21071","21098","21177","21261",
    "21271","21275","21282","21307","21332","21335","21340","21343","21355","21385","21390","21449","21532","21595","21615","21620","21662","21691","21692","21700","21821","21973","22034","22143","22246","22301",
    "22372","22625","22965","23154","23232","23442","23620","23622","23638","23654","23913","24025","24120","24388","24461","24599","24654","24706","24916","24932","24951","25202","25271","25337","25356","25396",
    "25449","25450","25498","25503","25627","25657","25672","25722","25751","25760","25779","25793","25822","25911","25980","25989","26042","26057","26091","26094","26181","26232","26332","26387","26452","26482",
    "26502","26570","26711","26719","26728","26784","26841","26865","27067","27092","27097","27195","27316","27404","27423","27483","27510","27572","27588","27614","27651","27743","27780","27806","27854","27867",
    "27966","28024","28082","28093","28140","28181","28207","28222","28270","28274","28295","28301","28302","28372","28378","28388","28435","28494","28557","28642","28662","28686","29005","29122","29197","29314",
    "29421","29439","29449","29570","29586","29742","29756","29804","29950","30044","30069","30155","30207","30262","30276","30338","30363","30371","30492","30520","30553","30574","30584","30635","30637","30663",
    "30685","30722","30739","30742","30826","30869","30952","30976","30996","31030","31080","31109","31147","31201","31236","31247","31255","31291","31316","31317","31337","31431","31493","31532","31617","31619",
    "31637","31711","31735","31806","31811","31896","31900","32146","32157","32214","32280","32288","32296","32299","32314","32327","32382","32476","32477","32518","32541","32542","32579","32681","32688","32716",
    "32724","32744","32751","32798","32848","32950","33013","33015","33055","33152","33184","33189","33213","33217","33259","33266","33267","33380","33417","33526","33672","33691","33704","33720","33777","33867",
    "33875","33925","33950","33975","34003","34041","34078","34112","34138","34230","34235","34285","34309","34312","34352","34370","34457","34492","34526","34535","34543","34549","34587","34621","34644","34671",
    "34697","34709","34714","34717","34718","34740","34764","34816","34847","34849","34929","34973","34975","34979","34984","35000","35065","35143","35159","35160","35170","35178","35200","35304","35353","35369",
    "35399","35455","35485","35519","35553","35592","35602","35637","35641","35648","35649","35666","35673","35674","35688","35855","35874","35911","35921","35945","36017","36055","36151","36244","36256","36320",
    "36354","36356","36364","36402","36478","36501","36533","36534","36555","36556","36594","36604","36675","36689","36723","36738","36743","36811","36865","36883","36958","37047","37053","37151","37169","37218",
    "37300","37376","37386","37407","37437","37547","37560","37572","37691","37696","37713","37739","37781","37800","37918","37931","37981","38047","38063","38074","38123","38163","38181","38202","38208","38248",
    "38336","38378","38395","38414","38423","38437","38455","38501","38502","38517","38560","38593","38605","38618","38648","38692","38735","38777","38826","38846","38907","38986","39001","39081","39085","39129",
    "39143","39214","39230","39237","39274","39290","39303","39345","39356","39372","39399","39410","39435","39504","39524","39583","39621","39658","39720","39810","39837","39858","39908","39909","39939","39976",
    "39981","40014","40028","40070","40108","40134","40177","40193","40200","40231","40240","40305","40389","40496","40510","40533","40572","40576","40600","40616","40669","40693","40760","40774","40791","40864",
    "40892","40894","40925","40961","40963","40995","41341","41351","41366","41397","41510","41511","41521","41604","41606","41752","41996","42002","42023","42255","42357","42437","42723","42877","42899","42974",
    "42996","43154","43156","43258","43299","43304","43306","43527","43555","43688","43692","43882","43932","44073","44099","44199","44227","44237","44355","44391","44407","44464","44648","44659","44664","44671",
    "44696","44705","44706","44738","44829","44833","44887","44888","44913","45018","45040","45063","45084","45102","45150","45152","45158","45192","45218","45278","45336","45453","45591","45790","45797","45808",
    "45824","45913","45922","45938","45949","45975","45990","45998","46008","46064","46065","46066","46078","46085","46100","46129","46165","46179","46241","46313","46344","46374","46387","46445","46542","46567",
    "46576","46603","46609","46621","46646","46662","46693","46883","46926","46964","46966","46975","47004","47015","47040","47062","47086","47170","47229","47271","47301","47304","47459","47531","47619","47620",
    "47720","47728","47851","47900","47905","47928","47979","48025","48043","48074","48080","48124","48126","48139","48204","48234","48334","48433","48524","48531","48543","48595","48598","48670","48671","48719",
    "48760","48971","48991","48995","49008","49014","49044","49078","49080","49130","49155","49179","49217","49246","49248","49284","49293","49304","49335","49384","49391","49405","49418","49431","49511","49544",
    "49583","49591","49625","49628","49653","49659","49674","49709","49758","49803","49860","49866","49902","49985","50008","50082","50179","50202","50351","50477","50567","50630","50649","50668","50675","50684",
    "50734","50759","50809","50827","50862","50879","50881","50896","50941","51027","51070","51262","51282","51287","51320","51411","51507","51553","51598","51651","51708","51730","51767","51782","51824","51872",
    "51874","51880","51943","51977","51982","51985","52003","52006","52038","52057","52114","52135","52147","52183","52234","52286","52446","52475","52513","52529","52537","52553","52560","52699","52717","52738",
    "52766","52775","52777","52797","52798","52806","52851","52873","52912","52915","52942","52963","52965","52976","52988","52996","52999","53006","53037","53098","53118","53139","53189","53304","53375","53378",
    "53415","53533","53587","53627","53630","53637","53670","53695","53696","53709","53751","53766","53818","53819","53853","53870","53890","53894","53920","53936","53949","53986","53997","54097","54121","54148",
    "54181","54192","54232","54300","54312","54401","54448","54497","54543","54556","54653","54695","54715","54746","54785","54846","54952","55053","55126","55148","55154","55165","55167","55185","55253","55256",
    "55271","55312","55333","55348","55357","55428","55440","55465","55471","55489","55490","55508","55517","55527","55534","55546","55567","55578","55645","55658","55705","55754","55771","55787","55797","55819",
    "55827","55843","55855","55904","55911","55914","55920","56010","56097","56131","56156","56251","56264","56295","56307","56322","56336","56338","56375","56379","56450","56458","56476","56524","56543","56545",
    "56591","56649","56661","56670","56691","56700","56806","56836","56893","56921","56924","56932","56974","57009","57061","57115","57142","57279","57360","57375","57379","57407","57413","57468","57556","57584",
    "57610","57625","57673","57700","57709","57727","57738","57744","57768","57777","57808","57811","57814","57834","57848","57851","57936","57948","58035","58049","58064","58203","58264","58315","58383","58498",
    "58519","58522","58542","58659","58700","58728","58813","58827","58873","58918","58976","59027","59197","59409","59414","59467","59497","59522","59654","59763","59764","59771","59822","59988","60015","60045",
    "60056","60119","60121","60161","60231","60282","60348","60357","60386","60392","60451","60476","60479","60504","60509","60524","60590","60629","60693","60713","60770","60773","60826","60870","60903","60959",
    "60965","61010","61018","61027","61067","61124","61150","61194","61198","61214","61286","61323","61346","61356","61361","61389","61457","61466","61485","61523","61532","61539","61579","61659","61678","61773",
    "61852","61952","61976","61992","62053","62054","62111","62116","62129","62149","62154","62204","62211","62217","62223","62263","62289","62377","62465","62473","62479","62486","62495","62550","62552","62629",
    "62630","62676","62684","62689","62704","62726","62813","62844","62897","62966","63004","63031","63043","63074","63079","63086","63094","63097","63169","63335","63365","63382","63536","63552","63636","63654",
    "63739","63975","63993","64022","64032","64047","64229","64344","64391","64458","64459","64477","64513","64560","64569","64613","64705","64718","64919","64964","64975","64981","65022","65053","65080","65101",
    "65169","65190","65229","65255","65260","65317","65359","65366","65439","65542","65565","65599","65669","65733","65966","65994","66025","66044","66049","66057","66066","66078","66079","66092","66138","66177",
    "66220","66224","66239","66266","66270","66462","66602","66664","66794","66833","66961","67116","67261","67278","67535","67621","67629","67896","67912","68117","68122","68207","68223","68231","68515","68528",
    "68532","68555","68685","68730","68859","69128","69258","69610","69634","69640","69644","69647","69649","69679","69732","69736","69753","69754","69755","69789","69819","69847","69869","69884","69914","69925",
    "69943","70014","70053","70110","70184","70216","70252","70253","70337","70338","70339","70356","70443","70551","70582","70607","70633","70635","70695","70719","70801","70802","70833","70841","70884","70912",
    "70942","71049","71134","71137","71172","71222","71239","71266","71306","71323","71397","71455","71464","71469","71584","71606","71621","71660","71707","71771","71792","71832","71839","71842","71847","71854",
    "71864","72012","72051","72238","72329","72352","72370","72383","72393","72394","72437","72470","72512","72520","72538","72544","72622","72639","72676","72715","72717","72720","72772","72854","72908","72914",
    "72924","72951","72961","73009","73032","73143","73173","73223","73256","73264","73285","73289","73312","73353","73366","73436","73442","73443","73474","73527","73625","73643","73645","73682","73699","73865",
    "73866","73945","74041","74170","74189","74298","74317","74318","74321","74327","74373","74382","74393","74394","74395","74410","74437","74522","74526","74681","74771","74818","74832","74914","74943","74959",
    "74986","75019","75065","75200","75383","75781","75852","75962","75971","76059","76062","76102","76109","76134","76226","76279","76285","76398","76429","76525","76546","76581","76629","76665","76669","76828",
    "76988","77042","77051","77114","77211","77218","77240","77307","77411","77413","77438","77443","77463","77478","77528","77625","77626","77639","77670","77678","77688","77712","77789","77796","77814","77913",
    "77917","77965","77973","78054","78058","78087","78210","78215","78224","78302","78332","78338","78368","78448","78508","78527","78539","78576","78649","78663","78701","78714","78739","78765","78925","78927",
    "78943","79001","79015","79128","79132","79157","79201","79284","79393","79487","79494","79577","79663","79751","79793","79909","79912","79914","79931","79970","79978","79995","80035","80068","80070","80108",
    "80119","80179","80215","80222","80242","80260","80261","80385","80449","80476","80615","80655","80668","80676","80732","80863","80870","80986","81041","81097","81187","81209","81220","81229","81252","81414",
    "81415","81424","81461","81547","81549","81598","81618","81672","81788","81797","81880","81881","81886","81930","81957","82000","82012","82047","82085","82086","82096","82119","82157","82158","82254","82264",
    "82309","82370","82377","82387","82405","82420","82421","82438","82466","82575","82638","82709","82911","82927","83061","83089","83168","83170","83211","83247","83297","83298","83299","83300","83301","83302",
    "83303","83304","83305","83306","83307","83308","83309","83310","83311","83312","83313","83314","83315","83316","83317","83318","83319","83320","83321","83322","83323","83324","83325","83326","83327","83328",
    "83329","83330","83331","83332","83333","83334","83335","83336","83337","83338","83339","83340","83341","83342","83343","83344","83345","83346","83347","83348","83349","83350","83351","83352","83353","83354",
    "83355","83356","83357","83358","83359","83360","83361","83362","83363","83364","83365","83366","83367","83368","83369","83370","83371","83372","83373","83374","83375","83376","83377","83378","83379","83380",
    "83381","83382","83383","83384","83385","83386","83387","83388","83389","83390","83391","83392","83393","83394","83395","83396","83397","83398","83399","83400","83401","83402","83403","83404","83405","83406",
    "83407","83408","83409","83410","83411","83412","83413","83414","83415","83416","83417","83418","83419","83420","83421","83422","83423","83424","83425","83426","83427","83428","83429","83430","83431","83432",
    "83433","83434","83435","83436","83437","83438","83439","83440","83441","83442","83443","83444","83445","83446","83447","83448","83449","83450","83451","83452","83453","83454","83455","83456","83457","83458",
    "83459","83460","83461","83462","83463","83464","83465","83466","83467","83468","83469","83470","83471","83472","83473","83474","83475","83476","83477","83478","83479","83480","83481","83482","83483","83484",
    "83485","83486","83487","83488","83489","83490","83491","83492","83493","83494","83495","83496","83497","83498","83499","83500","83501","83502","83503","83504","83505","83506","83507","83508","83509","83510",
    "83511","83512","83513","83514","83515","83516","83517","83518","83519","83520","83521","83522","83523","83524","83525","83526","83527","83528","83529","83530","83531","83532","83533","83534","83535","83536",
    "83537","83538","83539","83540","83541","83542","83543","83544","83545","83546","83547","83548","83549","83550","83551","83552","83553","83554","83555","83556","83557","83558","83559","83560","83561","83562",
    "83563","83564","83565","83566","83567","83568","83569","83570","83571","83572","83573","83574","83575","83576","83577","83578","83579","83580","83581","83582","83583","83584","83585","83586","83587","83588",
    "83589","83590","83591","83592","83593","83594","83595","83596","83597","83598","83599","83600","83601","83602","83603","83604","83605","83606","83607","83608","83609","83610","83611","83612","83613","83614",
    "83615","83616","83617","83618","83619","83620","83621","83622","83623","83624","83625","83626","83627","83628","83629","83630","83631","83632","83633","83634","83635","83636","83637","83638","83639","83640",
    "83641","83642","83643","83644","83645","83646","83647","83648","83649","83650","83651","83652","83653","83654","83655","83656","83657","83658","83659","83660","83661","83662","83663","83664","83665","83666",
    "83667","83668","83669","83670","83671","83672","83673","83674","83675","83676","83677","83678","83679","83680","83681","83682","83683","83684","83685","83686","83687","83688","83689","83690","83691","83692",
    "83693","83694","83695","83696","83697","83698","83699","83700","83701","83702","83703","83704","83705","83706","83707","83708","83709","83710","83711","83712","83713","83714","83715","83716","83717","83718",
    "83719","83720","83721","83722","83723","83724","83725","83726","83727","83728","83729","83730","83731","83732","83733","83734","83735","83736","83737","83738","83739","83740","83741","83742","83743","83744",
    "83745","83746","83747","83748","83749","83750","83751","83752","83753","83754","83755","83756","83757","83758","83759","83760","83761","83762","83763","83764","83765","83766","83767","83768","83769","83770",
    "83771","83772","83773","83774","83775","83776","83777","83778","83779","83780","83781","83782","83783","83784","83785","83786","83787","83788","83789","83790","83791","83792","83793","83794","83795","83796",
    "83797","83798","83799","83800","83801","83802","83803","83804","83805","83806","83807","83808","83809","83810","83811","83812","83813","83814","83815","83816","83817","83818","83819","83820","83821","83822",
    "83823","83824","83825","83826","83827","83828","83829","83830","83831","83832","83833","83834","83835","83836","83837","83838","83839","83840","83841","83842","83843","83844","83845","83846","83847","83848",
    "83849","83850","83851","83852","83853","83854","83855","83856","83857","83858","83859","83860","83861","83862","83863","83864","83865","83866","83867","83868","83869","83870","83871","83872","83873","83874",
    "83875","83876","83877","83878","83879","83880","83881","83882","83883","83884","83885","83886","83887","83888","83889","83890","83891","83892","83893","83894","83895","83896","83897","83898","83899","83900",
    "83901","83902","83903","83904","83905","83906","83907","83908","83909","83910","83911","83912","83913","83914","83915","83916","83917","83918","83919","83920","83921","83922","83923","83924","83925","83926",
    "83927","83928","83929","83930","83931","83932","83933","83934","83935","83936","83937","83938","83939","83940","83941","83942","83943","83944","83945","83946","83947","83948","83949","83950","83951","83952",
    "83953","83954","83955","83956","83957","83958","83959","83960","83961","83962","83963","83964","83965","83966","83967","83968","83969","83970","83971","83972","83973","83974","83975","83976","83977","83978",
    "83979","83980","83981","83982","83983","83984","83985","83986","83987","83988","83989","83990","83991","83992","83993","83994","83995","83996","83997","83998","83999","84000"
];*/
/*var listIndexUrlMots = [
    "186937","186938","186939","186940","186941","186942","186943","186944","186945","186946","186947","186948","186949","186950","186951","186952","186953","186954","186955","186956","186957","186958","186959",
    "186960","186961","186962","186963","186964","186965","186966","186967","186968","186969","186970","186971","186972","186973","186974","186975","186976","186977","186978","186979","186980","186981","186982",
    "186983","186984","186985","186986","186987","186988","186989","186990","186991","186992","186993","186994","186995","186996","186997","186998","186999","187000","187001","187002","187003","187004","187005",
    "187006","187007","187008","187009","187010","187011","187012","187013","187014","187015","187016","187017","187018","187019","187020","187021","187022","187023","187024","187025","187026","187027","187028",
    "187029","187030","187031","187032","187033","187034","187035","187036","187037","187038","187039","187040","187041","187042","187043","187044","187045","187046","187047","187048","187049","187050","187051",
    "187052","187053","187054","187055","187056","187057","187058","187059","187060","187061","187062","187063","187064","187065","187066","187067","187068","187069","187070","187071","187072","187073","187074",
    "187075","187076","187077","187078","187079","187080","187081","187082","187083","187084","187085","187087","187088","187090","187091","187092","187093","187094","187095","187096","187097","187098","187099",
    "187100","187101","187102","187103","187104","187105","187106","187107","187108","187109","187110","187111","187112","187113","187114","187115","187116","187117","187119","187120","187121","187122","187123",
    "187124","187125","187126","187127","187128","187129","187130","187131","187132","187133","187134","187135","187136","187137","187138","187139","187140","187141","187142","187143","187144","187145","187146",
    "187147","187148","187149","187150","187151","187152","187153","187154","187155","187156","187157","187158","187159","187160","187161","187162","187163","187164","187165","187166","187167","187168","187169",
    "187170","187171","187172","187173","187174","187175","187176","187177","187178","187179","187180","187181","187182","187183","187184","187185","187186","187187","187188","187189","187190","187191","187192",
    "187193","187194","187195","187196","187197","187198","187199","187200","187201","187202","187203","187204","187205","187206","187207","187208","187209","187210","187211","187212","187213","187214","187215",
    "187216","187217","187218","187219","187220","187221","187222","187223","187224","187225","187226","187227","187228","187229","187230","187231","187232","187233","187234","187235","187236","187237","187238",
    "187239","187240","187241","187242","187243","187244","187245","187246","187247","187248","187249","187250","187251","187252","187253","187254","187255","187256","187257","187258","187259","187260","187261",
    "187262","187263","187264","187265","187266","187267","187268","187269","187270","187271","187272","187273","187274","187275","187276","187277","187278","187279","187280","187281","187282","187283","187284",
    "187285","187286","187287","187288","187289","187290","187291","187292","187293","187294","187295","187296","187297","187298","187299","187300","187301","187302","187303","187304","187305","187306","187307",
    "187308","187309","187310","187311","187312","187313","187314","187315","187316","187317","187318","187319","187320","187322","187323","187324","187325","187326","187327","187328","187329","187330","187331",
    "187332","187333","187334","187335","187336","187337","187338","187339","187340","187341","187342","187343","187344","187345","187346","187347","187348","187349","187350","187351","187352","187353","187354",
    "187355","187356","187357","187358","187359","187360","187361","187362","187363","187364","187365","187366","187367","187368","187369","187370","187371","187372","187373","187374","187375","187379","187380",
    "187381","187388","187391","187392","187393","187396","187398","187399","187401","187402","187403","187404","187405","187406","187407","187408","187409","187410","187411","187412","187413","187414","187415",
    "187416","187417","187418","187419","187420","187421","187422","187423","187424","187425","187426","187427","187428","187429","187430","187431","187432","187433","187434","187435","187436","187437","187438",
    "187439","187440","187441","187442","187443","187444","187445","187446","187447","187448","187449","187450","187451","187452","187453","187454","187455","187456","187457","187458","187459","187460","187461",
    "187462","187463","187464","187465","187466","187467","187468","187469","187470","187471","187472","187473","187474","187475","187476","187477","187478","187479","187480","187481","187482","187483","187484",
    "187485","187486","187487","187488","187489","187490","187491","187492","187493","187494","187495","187496","187497","187498","187499","187500","187501","187502","187503","187504","187505","187506","187507",
    "187508","187509","187510","187511","187512","187513","187514","187515","187516","187517","187518","187519","187520","187521","187522","187523","187524","187525","187526","187527","187528","187529","187530",
    "187531","187532","187533","187534","187535","187536","187537","187538","187539","187540","187541","187542","187543","187544","187545","187546","187547","187548","187549","187550","187551","187552","187553",
    "187554","187555","187556","187557","187558","187559","187560","187561","187562","187563","187564","187565","187566","187567","187568","187569","187570","187571","187572","187573","187574","187575","187576",
    "187577","187578","187579","187580","187581","187582","187583","187584","187585","187586","187587","187588","187589","187590","187591","187592","187593","187594","187595","187596","187597","187598","187599",
    "187600","187601","187602","187603","187604","187605","187606","187607","187608","187609","187610","187611","187612","187613","187614","187615","187616","187617","187618","187619","187620","187621","187622",
    "187623","187624","187625","187626","187627","187628","187629","187630","187631","187632","187633","187634","187635","187636","187637","187638","187639","187640","187641","187642","187643","187644","187645",
    "187646","187647","187648","187649","187650","187651","187652","187653","187654","187655","187656","187657","187658","187659","187660","187661","187662","187663","187664","187665","187666","187667","187668",
    "187669","187670","187671","187672","187673","187674","187675","187676","187677","187678","187679","187680","187681","187682","187683","187684","187685","187686","187687","187688","187689","187690","187691",
    "187692","187693","187694","187695","187696","187697","187698","187699","187700","187701","187702","187703","187704","187705","187706","187707","187708","187709","187710","187711","187712","187713","187714",
    "187715","187716","187717","187718","187719","187720","187721","187722","187723","187724","187725","187726","187727","187728","187729","187730","187731","187732","187733","187734","187735","187736","187737",
    "187738","187739","187740","187741","187742","187743","187744","187745","187746","187747","187748","187749","187750","187751","187752","187753","187754","187755","187756","187757","187758","187759","187760",
    "187761","187762","187763","187764","187765","187766","187767","187768","187769","187770","187771","187772","187773","187774","187775","187776","187777","187778","187779","187780","187781","187782","187783",
    "187784","187785","187786","187787","187788","187789","187790","187791","187792","187793","187794","187795","187796","187797","187798","187799","187800","187801","187802","187803","187804","187805","187806",
    "187807","187808","187809","187810","187811","187812","187813","187814","187815","187816","187817","187818","187819","187820","187821","187822","187823","187824","187825","187826","187827","187828","187829",
    "187830","187831","187832","187833","187834","187835","187836","187837","187838","187839","187840","187841","187842","187843","187844","187845","187846","187847","187848","187849","187850","187851","187852",
    "187853","187854","187855","187856","187857","187858","187859","187860","187861","187862","187863","187864","187865","187866","187867","187868","187869","187870","187871","187872","187873","187874","187875",
    "187876","187877","187878","187879","187880","187881","187882","187883","187884","187885","187886","187887","187888","187889","187890","187891","187892","187893","187894","187895","187896","187897","187898",
    "187899","187900","187901","187902","187903","187904","187905","187906","187907","187908","187909","187910","187911","187912","187913","187914","187915","187916","187917","187918","187919","187920","187921",
    "187922","187923","187924","187925","187926","187927","187928","187929","187930","187931","187932","187933","187934","187935","187936","187937","187938","187939","187940","187941","187942","187943","187944",
    "187945","187946","187947","187948","187949","187950","187951","187952","187953","187954","187955","187956","187957","187958","187959","187960","187961","187962","187963","187964","187965","187966","187967",
    "187968","187969","187970","187971","187972","187973","187974","187975","187976","187977","187978","187979","187980","187981","187982","187983","187984","187985","187986","187987","187988","187989","187990",
    "187991","187992","187993","187994","187995","187996","187997","187998","187999","188000"
];*/
/*var listIndexUrlMots = [
    "10909889","10910042","10910121","10910122","10910124","10910125","10910126","10910127","10910128","10910129","10910130","10910131","10910132","10910133","10910134","10910135","10910136","10910137","10910138",
    "10910139","10910140","10910141","10910142","10910143","10910144","10910145","10910146","10910147","10910148","10910149","10910150","10910151","10910152","10910153","10910154","10910155","10910156","10910157",
    "10910158","10910159","10910160","10910161","10910162","10910163","10910164","10910165","10910166","10910167","10910168","10910169","10910170","10910171","10910172","10910173","10910174","10910175","10910176",
    "10910177","10910178","10910179","10910180","10910181","10910182","10910183","10910184","10910185","10910186","10910187","10910188","10910189","10910190","10910191","10910192","10910193","10910194","10910195",
    "10910196","10910197","10910198","10910199","10910200","10910201","10910202","10910203","10910204","10910205","10910206","10910207","10910208","10910209","10910210","10910211","10910212","10910213","10910214",
    "10910215","10910216","10910217","10910218","10910219","10910220","10910222","10910223","10910224","10910225","10910226","10910227","10910228","10910229","10910230","10910231","10910232","10910233","10910234",
    "10910235","10910236","10910237","10910238","10910239","10910240","10910241","10910242","10910243","10910244","10910245","10910246","10910247","10910248","10910249","10910250","10910251","10910252","10910253",
    "10910254","10910255","10910256","10910257","10910258","10910259","10910260","10910261","10910262","10910370","10910371","10910372","10910373","10910384","10910389","10910416","10910432","10910736","10910737",
    "10910738","10910739","10910740","10910741","10910742","10910743","10910744","10910745","10910746","10910747","10910748","10910749","10910750","10910751","10910752","10910753","10910754","10910755","10910756",
    "10910757","10910758","10910759","10910760","10910761","10910762","10910763","10910764","10910765","10910766","10910767","10910768","10910769","10910770","10910771","10910772","10910773","10910774","10910775",
    "10910776","10910777","10910778","10910779","10910780","10910781","10910782","10910783","10910784","10910785","10910786","10910787","10910788","10910789","10910790","10910791","10910792","10910793","10910794",
    "10910795","10910796","10910797","10910798","10910799","10910800"
];*/
var listIndexUrlMots = [
   "10919675","10919676","10919677","10919678","10919679","10919680","10919681","10919682","10919683","10919684","10919685","10919686","10919687","10919688","10919689","10919690","10919691","10919692","10919693",
   "10919694","10919695","10919696","10919697","10919698","10919699","10919700","10919701","10919702","10919703","10919704","10919705","10919706","10919707","10919708","10919709","10919710","10919711","10919712",
   "10919713","10919714","10919715","10919716","10919717","10919718","10919719","10919720","10919721","10919722","10919723","10919724","10919725","10919726","10919727","10919728","10919729","10919730","10919731",
   "10919732","10919733","10919734","10919735","10919736","10919737","10919738","10919739","10919740","10919741","10919742","10919743","10919744","10919745","10919746","10919747","10919748","10919749","10919750",
   "10919751","10919752","10919753","10919754","10919755","10919756","10919757","10919758","10919759","10919760","10919761","10919762","10919763","10919764","10919765","10919766","10919767","10919768","10919769",
   "10919770","10919771","10919772","10919773","10919774","10919775","10919776","10919777","10919778","10919779","10919780","10919781","10919782","10919783","10919784","10919785","10919786","10919787","10919788",
   "10919789","10919790","10919791","10919792","10919793","10919794","10919795","10919796","10919797","10919798","10919799","10919800","10919801","10919802","10919803","10919804","10919805","10919806","10919807",
   "10919808","10919809","10919810","10919811","10919812","10919813","10919814","10919815","10919816","10919817","10919818","10919819","10919820","10919821","10919822","10919823","10919824","10919825","10919826",
   "10919827","10919828","10919829","10919830","10919831","10919832","10919833","10919834","10919835","10919836","10919837","10919838","10919839","10919840","10919841","10919842","10919843","10919844","10919845",
   "10919846","10919847","10919848","10919849","10919850","10919851","10919852","10919853","10919854","10919855","10919856","10919857","10919858","10919859","10919860","10919861","10919862","10919863","10919864",
   "10919865","10919866","10919867","10919868","10919869","10919870","10919871","10919872","10919873","10919874","10919875","10919876","10919877","10919878","10919879","10919880","10919881","10919882","10919883",
   "10919884","10919885","10919886","10919887","10919888","10919889","10919890","10919891","10919892","10919893","10919894","10919895","10919896","10919897","10919898","10919899","10919900","10919901","10919902",
   "10919903","10919904","10919905","10919906","10919907","10919908","10919909","10919910","10919911","10919912","10919913","10919914","10919915","10919916","10919917","10919918","10919919","10919920","10919921",
   "10919922","10919923","10919924","10919925","10919926","10919927","10919928","10919929","10919930","10919931","10919932","10919933","10919934","10919935","10919936","10919937","10919938","10919939","10919940",
   "10919941","10919942","10919943","10919944","10919945","10919946","10919947","10919948","10919949","10919950","10919951","10919952","10919953","10919954","10919955","10919956","10919957","10919958","10919959",
   "10919960","10919961","10919962","10919963","10919964","10919965","10919966","10919967","10919968","10919969","10919970","10919971","10919972","10919973","10919974","10919975","10919976","10919977","10919978",
   "10919979","10919980","10919981","10919982","10919983","10919984","10919985","10919986","10919987","10919988","10919989","10919990","10919991","10919992","10919993","10919994","10919995","10919996","10919997",
   "10919998","10919999","10920000"    
];
var listeUrlMots = {};
listeUrlMots.urls = [];

for(var i = 0; i < listIndexUrlMots.length ; i++) {
    listeUrlMots.urls.push("http://www.larousse.fr/dictionnaires/francais/a/" + listIndexUrlMots[i]);
}

var indexDef = 0;
var dataAllDef = "";
var dataPart = "";

var getDefs2 = function(){
    http.get(listeUrlMots.urls[indexDef], function(res){

        res.on('data', function(data){
            //dataAll += data;
            if (res.statusCode === 200) {
                dataPart += data;     
            }
        });

        res.on('end', function () {
            dataAllDef += dataPart.substring(
                dataPart.lastIndexOf('<article class="BlocDefinition content" role="article">'),
                dataPart.indexOf("</article>", 
                    dataPart.lastIndexOf('<article class="BlocDefinition content" role="article">')
                )
            ) + "</article>";
            dataPart = "";
            console.log(listeUrlMots.urls[indexDef]);
            indexDef++;
            if(indexDef < listeUrlMots.urls.length){
                fs.writeFile('AllDefsSuite.txt', dataAllDef , function (err) {
                    if (err) {
                        console.log(err);
                        indexDef--;
                        getDefs2();
                    }
                    console.log('It\'s saved!');
                    //setTimeout(()=>{
                        getDefs2();
                    //},4000);
                });
            } else {
                fs.writeFile('AllDefsSuite.txt', dataAllDef , function (err) {
                    if (err) throw err;
                    console.log('It\'s saved!');
                });
            }
        });
 
        res.on('error', function(e){
            console.log(e);
            getDefs2();
        });
    });
}

/*setTimeout(()=>{
    //getUrlsMots();
    //getDefs();
    //getImgs();
    //getDefs2();
},5000);*/


/*var urlMotTemp = [];

listeUrlMots.urls.forEach((element)=>{
    if(urlMotTemp.indexOf(element) == -1 && element.substring(0,46) === "http://www.larousse.fr/dictionnaires/francais/" ){
        urlMotTemp.push(element);
    }
});

fs.writeFile('urlAgain.txt', urlMotTemp.join('","') , function (err) {
    if (err) throw err;
    console.log('It\'s saved!');
});*/

            /**********************************************************************
             *                                                                    *
             *                  FIN RECUPERATION DES DEFINITIONS                  *
             *                                                                    *
             **********************************************************************/   

/*
// GET : read one
app.get('/users/:userId', function (req,res){
    console.log("user details : " + req.params.userId);
    db.collection('users').findOne({_id : new ObjectID(req.params.userId)},(err, result) => {
        if (err == null)
        {
            console.log(result);
            res.send(result);
        } 

        return console.log(err);
    }) 
})

// GET : many params example
app.get('/users2/:flag1.:flag2', function (req,res){
    res.send('users <br/>- flag1 : ' + req.params.flag1 + '<br/>- flag2 : ' + req.params.flag2);
})

// GET : many params alternative example
app.get('/users3/:flag1-:flag2', function (req,res){
    res.send('users <br/>- flag1 : ' + req.params.flag1 + '<br/>- flag2 : ' + req.params.flag2);
})

// POST : create
app.post('/users/', function(req, res){
    console.log('user created');
    console.log(req.body);
    
    db.collection('users').save(req.body, (err, result) => {
        if (err) return console.log(err)

        console.log('saved to database')
        res.redirect('/')
    })
})

// PUT : update one
app.put('/users/:userId', function(req, res){
    console.log('user updated : ' + req.params.userId);
    console.log(req.body);

    db.collection('users').findOneAndUpdate({_id : new ObjectID(req.params.userId)}, {
        $set: {
            lastname: req.body.lastname,
            firstname: req.body.firstname
        }
    }, {
        sort: {_id: -1},
        upsert: true
    }, (err, result) => {
        if (err) return res.send(err)
        res.send(result)
    })
})

// DELETE : delete
app.delete('/users/:userId', function(req, res){
    console.log('user deleted : ' + req.params.userId)
    db.collection('users').findOneAndDelete({_id : new ObjectID(req.params.userId)},
    (err, result) => {
        if (err) return res.send(500, err)
        
        res.send('user deleted')    
    })
})*/